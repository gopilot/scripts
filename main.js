jQuery(function(e){function t(){o.removeClass("show")}function s(){return m&&emailOk&&(numOk&&cvcOk&&expOk||e(".modal-content").hasClass("no-credit-card"))?(c.removeClass("disabled"),e(".input-error-text").removeClass("show")):c.addClass("disabled"),m&&emailOk&&(numOk&&cvcOk&&expOk||e(".modal-content").hasClass("no-credit-card"))}function n(t){e("js-submit").html('<i class="pe-7s-config spin"></i>');var s={user:{name:e("input.name").val(),email:e("input.email").val()},discount:e("input.discount").val()||!1};t&&(s.stripe_token=t);var n=setTimeout(function(){e(".js-submit").addClass("fail"),e(".js-submit").html('<i class="pe-7s-close-circle"></i>'),setTimeout(function(){e(".js-submit").html("Register"),e(".js-submit").removeClass("has-icon"),e(".js-submit").removeClass("fail")},1500),e(".input-error-text.cc").text("Uh oh, something's wrong... Try again in a little bit."),e(".input-error-text.cc").addClass("show")},1e4);e.postJSON("https://api.gopilot.org/events/"+PILOT_EVENT_ID+"/register",s,function(t){console.log("Done!",t),e(".button.js-complete").attr("href","/complete.html?token="+t.token),e(".js-submit").addClass("success"),e(".js-submit").html('<i class="pe-7s-check"></i>'),setTimeout(function(){e(".modal-content").removeClass("step-1"),e(".modal-content").addClass("step-2")},1500)},function(t){console.log(t),clearTimeout(n),e(".js-submit").addClass("fail"),e(".js-submit").html('<i class="pe-7s-close-circle"></i>'),setTimeout(function(){e(".js-submit").html("Register"),e(".js-submit").removeClass("has-icon"),e(".js-submit").removeClass("fail")},1500);var s="name"==t.reason?"name":"email"==t.reason?"email":"cc";e(".input-error-text."+s).text(t.message),e(".input-error-text."+s).addClass("show");var r=!1;"cc"!=s?r=s:"number"==t.reason?r="cc-num":"cvc"==t.reason?r="cc-cvc":"exp_month"==t.reason||"exp_year"==t.reason?r="cc-exp":("charge"==t.reason||"customer"==t.reason)&&(r="cc-num"),r&&e("input."+r).parent().addClass("error")})}Stripe.setPublishableKey("pk_live_BXRjo7MBwBvPSNM1338ZQVj3"),e.postJSON=function(e,t,s,n){return console.log("POSTing ",t),jQuery.ajax({type:"POST",url:e,contentType:"application/json",data:JSON.stringify(t),dataType:"json",success:s,error:function(e){return console.log("error",e),console.log("error text",e.responseText),n(JSON.parse(e.responseText),e.statusCode())}})};var r=["visa","mastercard","amex","dinersclub","jcb"],a=e(".js-register"),o=e("#registerModal"),i=e(".js-modal-close"),c=e(".js-submit"),l=e(".modal-overlay");a.on("click",function(){o.addClass("show"),e("input.name").focus(),l.unbind("click",t),l.on("click",t)}),i.on("click",function(e){e.stopPropagation(),t()}),e(".show-discount").on("click",function(){var t=e("input.discount").parent();t.hasClass("hidden")?(e(".modal-content").addClass("show-discount"),t.removeClass("hidden"),e("input.discount").focus(),e(this).text("Hide discount field")):(t.addClass("hidden"),e(this).text("Have a discount code?"),e(".modal-content").removeClass("show-discount"),e(".register-form").removeClass("no-credit-card"),e(this).val(""))}),e("input.cc-num").payment("formatCardNumber"),e("input.cc-exp").payment("formatCardExpiry"),e("input.cc-cvc").payment("formatCardCVC"),e("[data-numeric]").payment("restrictNumeric"),e("input:not(.cc-num)").typeWatch({event:"typingDone",wait:750});var d,m=emailOk=numOk=cvcOk=expOk=!1;e("input.cc-num").on("keyup",function(){e(this).parent().removeClass("empty error");var t=e.payment.cardType(parseInt(e(this).val()));t!=d&&(d&&e(this).siblings(".card").removeClass(d),t&&(-1!=r.indexOf(t)?(e(this).siblings(".card").addClass(t),d=t):d=null))}),e("input.name").on("typingDone",function(){e(this).parent().removeClass("empty"),m=e(this).val().match(/^[a-zA-Z\\s]+ /i),s(),m?e(this).parent().removeClass("error"):e(this).parent().addClass("error")}),e("input.email").on("typingDone",function(){e(this).parent().removeClass("empty"),emailOk=e(this).val().match(/\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,4}\b/i),s(),emailOk?e(this).parent().removeClass("error"):e(this).parent().addClass("error")}),e("input.cc-num").on("blur",function(){if(e(this).val()){if(console.log(d),!d||void 0==d){{e(this).siblings(".card").addClass("pe-7s-check")}d="pe-7s-check"}e(this).parent().removeClass("empty"),numOk=e.payment.validateCardNumber(e(this).val()),s(),numOk?e(this).parent().removeClass("error"):e(this).parent().addClass("error")}}),e("input.cc-cvc").on("typingDone",function(){e(this).parent().removeClass("empty"),cvcOk=e.payment.validateCardCVC(e(this).val(),d),s(),cvcOk?e(this).parent().removeClass("error"):e(this).parent().addClass("error")}),e("input.cc-exp").on("typingDone",function(){e(this).parent().removeClass("empty");var t=e(this).payment("cardExpiryVal");expOk=e.payment.validateCardExpiry(t.month,t.year),s(),expOk?e(this).parent().removeClass("error"):e(this).parent().addClass("error")}),e("input.discount").on("typingDone",function(){var t=this;return e(this).hasClass("hidden")?(e(this).val(),e(this).parent().addClass("empty"),e(this).parent().removeClass("error"),e(".input-error-text.discount").removeClass("show"),void e(".register-form").removeClass("no-credit-card")):(e(this).parent().removeClass("empty"),""==e(this).val()?void e(this).parent().addClass("empty"):void e.get("https://api.gopilot.org/events/"+PILOT_EVENT_ID+"/discounts/"+e(this).val()).error(function(s,n){console.log("Error",s,n),e(".input-error-text.discount").removeClass("show"),e(".register-form").removeClass("no-credit-card"),e(t).parent().addClass("error")}).done(function(n,r){console.log(n,r),n.active?(e(t).parent().removeClass("error"),e(".js-total").text(" $"+(PILOT_EVENT_PRICE-n.amount)),e(".input-error-text.discount").text("$"+n.amount+" ("+n.title+")").addClass("green show"),PILOT_EVENT_PRICE<=n.amount?e(".modal-content").addClass("no-credit-card"):e(".modal-content").removeClass("no-credit-card")):(console.log("adding discount error",n,r),e(t).parent().addClass("error"),e(".modal-content").removeClass("no-credit-card"),e(".input-error-text.discount").removeClass("green"),e(".input-error-text.discount").text("Discount Expired"),e(".input-error-text.discount").addClass("show")),s()}))}),e(".js-submit").on("click",function(t){if(t.preventDefault(),e("input.name").trigger("typingDone"),e("input.email").trigger("typingDone"),e(".modal-content").hasClass("no-credit-card")||(e("input.cc-num").trigger("blur"),e("input.cc-cvc").trigger("typingDone"),e("input.cc-exp").trigger("typingDone")),e("input.discount").hasClass("hidden")||e("input.discount").trigger("typingDone"),s()){var r=e("input.cc-exp").payment("cardExpiryVal");if(e(".modal-content").hasClass("no-credit-card"))n();else{var a={number:e("input.cc-num").val(),cvc:e("input.cc-cvc").val(),exp_month:r.month,exp_year:r.year};Stripe.card.createToken(a,function(e,t){t.error?console.log("Error!",t.error):(console.log("Card",t.card),n(t.id))})}e(".js-submit").addClass("has-icon"),e(".js-submit").html('<i class="pe-7s-config spin"></i>')}})});